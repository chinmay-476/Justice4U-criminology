{% extends 'super_admin_base.html' %}

{% block title %}Admin Password Management - Super Admin Panel{% endblock %}

{% block page_title %}Admin Password Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Admin Password Management</li>
{% endblock %}

{% block content %}
<style>
.form-control.is-valid {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.password-match-indicator {
    font-size: 0.875rem;
    font-weight: 500;
}

.password-strength .progress {
    border-radius: 4px;
}

#admin-details .card {
    border-left: 4px solid #17a2b8;
}

#submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-cog"></i> Admin Password Management
                </h3>
            </div>
            
            <form action="{{ url_for('admin_password_reset') }}" method="POST" id="password-reset-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="card-body">
                    <!-- Admin Selection Dropdown -->
                    <div class="form-group">
                        <label for="admin_id">
                            <i class="fas fa-user-tie"></i> Select Admin
                        </label>
                        <select name="admin_id" id="admin_id" required>
                            <option value="">-- Select Admin to Reset Password --</option>
                            {% for admin in admins %}
                            <option value="{{ admin.id }}" data-username="{{ admin.username }}" data-email="{{ admin.email }}">
                                {{ admin.username }} ({{ admin.email }})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Choose the admin whose password you want to reset</small>
                    </div>

                    <!-- Admin Details Display -->
                    <div class="form-group" id="admin-details" style="display: none;">
                        <div class="card card-info">
                            <div class="card-body p-3">
                                <h6 class="card-title"><i class="fas fa-info-circle"></i> Selected Admin Details</h6>
                                <p class="mb-1"><strong>Username:</strong> <span id="selected-username">-</span></p>
                                <p class="mb-0"><strong>Email:</strong> <span id="selected-email">-</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Password Fields -->
                    <div class="form-group">
                        <label for="new_password">
                            <i class="fas fa-key"></i> New Password
                        </label>
                        <input type="password" 
                               name="new_password" 
                               id="new_password"
                               class="form-control" 
                               placeholder="Enter new password" 
                               required
                               minlength="6">
                        <small class="form-text text-muted">Password must be at least 6 characters long</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">
                            <i class="fas fa-check-double"></i> Confirm New Password
                        </label>
                        <input type="password" 
                               name="confirm_password" 
                               id="confirm_password"
                               class="form-control" 
                               placeholder="Confirm new password" 
                               required
                               minlength="6">
                        <div class="password-match-indicator mt-2" id="password-match" style="display: none;"></div>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="form-group">
                        <div class="password-strength" id="password-strength" style="display: none;">
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" id="strength-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="form-text" id="strength-text">Password strength: </small>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="fas fa-save"></i> Reset Admin Password
                    </button>
                    <a href="{{ url_for('department') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Admin selection handler
    $('#admin_id').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var username = selectedOption.data('username');
        var email = selectedOption.data('email');
        
        if ($(this).val()) {
            $('#selected-username').text(username);
            $('#selected-email').text(email);
            $('#admin-details').show();
            validateForm();
        } else {
            $('#admin-details').hide();
            $('#submit-btn').prop('disabled', true);
        }
    });

    // Password confirmation validation
    $('#confirm_password').on('keyup', function() {
        var password = $('#new_password').val();
        var confirmPassword = $(this).val();
        
        if (confirmPassword) {
            if (password === confirmPassword) {
                $(this).removeClass('is-invalid').addClass('is-valid');
                $('#password-match').removeClass('text-danger').addClass('text-success')
                    .html('<i class="fas fa-check"></i> Passwords match').show();
            } else {
                $(this).removeClass('is-valid').addClass('is-invalid');
                $('#password-match').removeClass('text-success').addClass('text-danger')
                    .html('<i class="fas fa-times"></i> Passwords do not match').show();
            }
        } else {
            $(this).removeClass('is-valid is-invalid');
            $('#password-match').hide();
        }
        validateForm();
    });

    // Password strength indicator
    $('#new_password').on('keyup', function() {
        var password = $(this).val();
        var strength = 0;
        var strengthText = '';
        var strengthColor = '';

        if (password.length >= 6) strength += 1;
        if (password.match(/[a-z]/)) strength += 1;
        if (password.match(/[A-Z]/)) strength += 1;
        if (password.match(/[0-9]/)) strength += 1;
        if (password.match(/[^a-zA-Z0-9]/)) strength += 1;

        switch (strength) {
            case 0:
            case 1:
                strengthText = 'Very Weak';
                strengthColor = 'bg-danger';
                break;
            case 2:
                strengthText = 'Weak';
                strengthColor = 'bg-warning';
                break;
            case 3:
                strengthText = 'Fair';
                strengthColor = 'bg-info';
                break;
            case 4:
                strengthText = 'Good';
                strengthColor = 'bg-primary';
                break;
            case 5:
                strengthText = 'Strong';
                strengthColor = 'bg-success';
                break;
        }

        if (password) {
            $('#strength-bar').css('width', (strength * 20) + '%').removeClass()
                .addClass('progress-bar ' + strengthColor);
            $('#strength-text').text('Password strength: ' + strengthText);
            $('#password-strength').show();
        } else {
            $('#password-strength').hide();
        }
        
        validateForm();
    });

    // Form validation
    function validateForm() {
        var adminSelected = $('#admin_id').val() !== '';
        var password = $('#new_password').val();
        var confirmPassword = $('#confirm_password').val();
        var passwordsMatch = password === confirmPassword && password.length >= 6;
        
        if (adminSelected && passwordsMatch) {
            $('#submit-btn').prop('disabled', false);
        } else {
            $('#submit-btn').prop('disabled', true);
        }
    }

    // Test button click
    $('#submit-btn').on('click', function(e) {
        console.log('Submit button clicked');
        console.log('Button disabled:', $(this).prop('disabled'));
        
        // If button is disabled, prevent form submission
        if ($(this).prop('disabled')) {
            e.preventDefault();
            console.log('Button is disabled, preventing submission');
            return false;
        }
    });

    // Form submission with confirmation
    $('#password-reset-form').on('submit', function(e) {
        var adminName = $('#admin_id option:selected').text();
        var newPassword = $('#new_password').val();
        var confirmPassword = $('#confirm_password').val();
        
        // Debug logging
        console.log('Form submitted');
        console.log('Admin:', adminName);
        console.log('Password:', newPassword);
        console.log('Confirm Password:', confirmPassword);
        
        e.preventDefault();
        
        // Validate before showing confirmation
        if (!adminName || adminName === '-- Select Admin to Reset Password --') {
            Swal.fire('Error', 'Please select an admin.', 'error');
            return;
        }
        
        if (!newPassword || !confirmPassword) {
            Swal.fire('Error', 'Please fill in all password fields.', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            Swal.fire('Error', 'Passwords do not match.', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            Swal.fire('Error', 'Password must be at least 6 characters long.', 'error');
            return;
        }
        
        Swal.fire({
            title: 'Confirm Password Reset',
            html: `
                <div class="text-left">
                    <p><strong>Admin:</strong> ${adminName}</p>
                    <p><strong>New Password:</strong> ${newPassword}</p>
                    <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> This action cannot be undone!</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, Reset Password!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'Resetting Password...',
                    text: 'Please wait while we update the password.',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Submit the form
                console.log('Submitting form...');
                this.submit();
            }
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
